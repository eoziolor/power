---
title: "Power project"
author: "Elias"
date: "May 10, 2018"
output:
  html_document: default
  pdf_document: default
---
# __Power project__ Part I: Age

## Introductions

My name is Elias Oziolor and I am a scientist. Most of the time I study how organisms evolve to resist human derived pollution, but that also entails dealing with a lot of data. The more I do this, the more I realized that I really enjoy playing with data and trying to tease apart the patterns that it is _hiding_. Some people use the metaphore of a puzzle, but I think of it as a big fat knot. It is frustrating and messy, but as you begin to unwinding it, there is a great sense of accomplishment in figuring out the patterns.

__So why do I start with powerlifter data?__

* Powerlifting is my hobby. Nowadays it's one of the only ones that I consistently pursue as my job takes over most of my time, but I like to spare an hour here and there and lift some heavy weights. 
* I love digging through data and I recently found this dataset that has some potential.
* One of my goals in life is to teach and inspire people to think critically, as well as be creative with my own research.

What I'll do here is epxlore a large dataset and see what kinds of patterns I can tease out by playing with the data and doing some stats on it.

### What you need to keep in mind

__I am not a human health and performance scientist!__ Any of the conclusions that I make here are purely derived from the data of a bunch of strong women and men, lifting weights. I will try to make no absolute claims on human performance or abilities. Here I hope to inspire some poeple to not take what others tell them at face value, and also to see what 600 000 powerlifting results can teach us about strength.

### The data
__This dataset has 600 000 entries!__ Many of these are partial and I will filter them out in some analyses and not others. I will keep you informed on the sample size of each graph and how strong I think the conclusions drawn from it can be. I downloaded the data from https://www.openpowerlifting.org/data.html on May 9th, 2018. __SO CAN YOU__.

The other big goal of this dataset is to showcase that you can do all of this analysis if you wanted to. Alongside the blogpost (which includes text and figures), I will also post a markdown version of the post. This will include all of my code, with annotations for what each portion is doing. All of this analysis is done in R, which is the language that feels the most intuitive to me for reformatting and plotting data. If you want to learn - check out the code.

### Comments and questions

If you have comments, concerns or just questions about the analysis or code _do not hesitate to contact me_! I am happy to chat about this.

__Now let's play__

The first thing that I will do is getting the data and all the necessary packages that I need from R to analyze it.

```{r}
library(lme4)
library(tidyr)
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(gtools)
library(tinytex)

open<-read.csv("openpowerlifting2.csv",head=TRUE,stringsAsFactors = FALSE) #reading in a re-formatted and merged version of the two csv documents that come from the openpowerlifting database
# open<-read.csv("openpowerlifting.csv",head=TRUE,stringsAsFactors = FALSE) #reading in the first csv document
# meets<-read.csv("meets.csv",head=TRUE,stringsAsFactors = FALSE) #reading in the one containing meets
# all<-merge(open,meets,by="MeetID") #merging them by column (MeetID, the only repeated column)
# 
str(open) #getting the structure of the new document

```
* Let's start taking a look at the data.
    + First I will group people in age groups (5 year groups)
    + Then subset it into men and women

```{r}
#Creating a vector of ages in increments of 5
# group<-seq(from=range(all$Age,na.rm=TRUE)[[1]],
#             to=range(all$Age,na.rm=TRUE)[[2]],
#             by=5)
# 
# group_range<-c() #creating a vector that will hold those ranges
# group2<-c(group-1,100) #creating a second vector that has 100 as the maximum of it
# for(i in 1:length(group)){ #creating teh group-range vector that will have info about a range, rather than a single digit
#  if(i==length(group)){group_range[i]<-paste(c(group[i],"100"),collapse="-")
#  next()
#  }
#  group_range[i]<-(paste(c(group[i],group2[i+1]),collapse="-"))
# } #making these into ranges rather than just the minimums
# 
#Run the following only once as it takes a while (20 mins)
# all<-cbind(all,Group=NA) # Adding a column of Group to the big dataset
# all$Age<-round(all$Age) #rounding age because the following code doesn't deal well with .5's and they are stupid anyways
# 
# #adding a column of ranges
# for(i in 1:length(all$Age)){
#  if(is.na(all$Age[i])){next()} #remove this estimation from all NAs
#  for(j in 1:length(group)){
#    if(all$Age[i]>=group[j]&&all$Age[i]<=group2[j+1]){ #iterate over groups and find which group Age this falls into
#    all$Group[i]<-group_range[j] #assign the necessary group range to that age
#    }
#  }
# }
# 
# # #writing table for future use because the chunk above takes FOREVER
# write.table(all,"openpowerlifting2.csv",quote=FALSE,row.names = FALSE,sep=',')

ord<-mixedorder(open$Group)
open2<-open[ord,]

open2$Group<-factor(open2$Group,levels=unique(open2$Group))

men<-open2 %>% 
  filter(BestBenchKg>0 & BestDeadliftKg>0 & BestSquatKg>0) %>% 
  filter(!is.na(Age)) %>% 
  filter(Sex=="M") %>% 
  select(Equipment,Age,BodyweightKg,BestSquatKg,BestBenchKg,BestDeadliftKg,TotalKg,Wilks,Group)

women<-open2 %>% 
  filter(BestBenchKg>0 & BestDeadliftKg>0 & BestSquatKg>0) %>% 
  filter(!is.na(Age)) %>% 
  filter(Sex=="F") %>% 
  select(Equipment,Age,BodyweightKg,BestSquatKg,BestBenchKg,BestDeadliftKg,TotalKg,Wilks,Group)

```
## Age

* Now I'll try to figure out if Age has an effect on performance...and what that effect is
  + I am starting with male data and then verify trends on females
  + Purely driven by the fact that there is much more data for men, so the relationships can be seen more clearly

```{r}
ggplot(men,
       aes(x=Age,y=TotalKg,color=BodyweightKg)) +
  geom_point(cex=.7) +
  facet_wrap(~Equipment) +
  scale_color_gradient2(guide="colourbar",low="yellow",mid="gold",high="red")

ggplot(women,
       aes(x=Age,y=TotalKg,color=BodyweightKg)) +
  geom_point(cex=.7) +
  facet_wrap(~Equipment) +
  scale_color_gradient2(guide="colourbar",low="yellow",mid="gold",high="red")

```


* There's an obvious peak around age 25, with a slowdown afterwards. What does that mean? We have a ton of data and variability, let's take a look.

* Let's see distribution of data in different ages to see how representative we are and what the resolution is

```{r}

ggplot(men,
       aes(x=Group,y=TotalKg,fill=Group))+
  geom_violin(draw_quantiles=c(0.5),aes(fill=Group),trim=TRUE,scale="width") +
  facet_wrap(~Equipment) +
  theme(axis.text.x=element_text(angle=90))

# fit<-aov(TotalKg~Group,data=men)
line<-lm(TotalKg~Age+BodyweightKg+Equipment,data=men)

# layout(matrix(c(1,2,3,4),2,2))
# plot(line)
summary(line)

```

* Let's cull the data to remove people under 22...creates a weird hump that may be obscuring some things
* Below I only work with data of men above 22 and then I'll check if this is consistent for younger males

```{r}
men2<-men %>% 
  filter(Age>24)

ggplot(men2,
       aes(x=Group,y=TotalKg,fill=Group))+
  geom_violin(draw_quantiles=c(0.5),aes(fill=Group),trim=FALSE) +
  facet_wrap(~Equipment) +
  theme(axis.text.x=element_text(angle=90))


line<-lm(TotalKg~Age*BodyweightKg+Equipment,data=men2)
# layout(matrix(c(1,2,3,4),2,2))
# plot(wa)
summary(line)
```

##Age and Bodyweight seem to have different influences on lifting
* What's happening here
  + What you see here is that when we look at Age, it has a negative relationship with Total weight lifted. What does this mean?
  + One interpretation is that as you get older, it's more difficult to lift heavy weights...duh
  + Obviously we have a bodyweight disparity here too, where the bigger you are, the more you will lift
  + An interesting interaction here suggests though, that there is a negative correlation between age and bodyweight, meaning: the older you are, you lose bang for the buck in bodyweight - is this real?

* So far we have been looking at this accross all equipment types, let's break it down and see if these relationships hold among all


```{r}
menm<-men2 %>% 
  filter(Equipment=="Multi-ply")

menr<-men2 %>% 
  filter(Equipment=="Raw")

mens<-men2 %>% 
  filter(Equipment=="Single-ply")

menw<-men2 %>% 
  filter(Equipment=="Wraps")

mm<-lm(TotalKg~Age*BodyweightKg,data=menm)
summary(mm)

mr<-lm(TotalKg~Age*BodyweightKg,data=menr)
summary(mr)

ms<-lm(TotalKg~Age*BodyweightKg,data=mens)
summary(ms)

mw<-lm(TotalKg~Age*BodyweightKg,data=menw)
summary(mw)
```

* So this is __REALLY__ interesting!
  + What you see here is that there is a small and significant relationship between age and total weight lifted, __but__ the stronger relationship is between bodyweight and total weight lifted

* What does this mean for our interaction and the relationship between Age and Bodyweight?
  + When looking at Multi-Ply lifters we see that age has a __strong negative__ effect on total weight lifted, bodyweight has a __strong positive__ effect...no interaction though. Meaning you don't lose weight to lifted weight relationship with age.
  + Raw lifters: __Small__ negative relationship of Age, positive relationship of weight, __small__ but present negative interaction of age and weight (lose bang for buck of gaining weight with age)
  + Single-ply: __sizeable__ negative relationship of Age, __strong__ positive relationship of weight, __small__ but present negative interaction of age and weight
  + Wraps: __Large__ negative relationship of Age, positive relationship of weight, no interaction.
  
* is this caused just because of lack of representation of older or bigger lifters in some leagues?

```{r}
ggplot(men2,
       aes(x=Equipment,y=Age,fill=Equipment))+
  geom_violin(draw_quantiles = c(0.5))

ggplot(men2,
       aes(x=Equipment,y=BodyweightKg,fill=Equipment))+
  geom_violin(draw_quantiles = c(0.5),trim=FALSE)

ggplot(men2,
       aes(x=Age,y=BodyweightKg,color=Equipment))+
  geom_point()+
  facet_wrap(~Equipment)
```

* When we look at Age, we do see that there are proportionally slightly more older lifters in the Multy-ply and Single-ply categories

* There is a strange trend to have lifters of heavier lifters in the Multi-ply and Wraps divisions. This could be a difference in the weight categories offered by different leagues that support multi-ply, vs ones that don't.
  + you can see clearly the categories by the wiggle in distribution, each wiggle is a high proportion of people likely at the top of their weight class, where there are less lifters at the bottom of a weight class
  +These are the only two divisions that do not have a interaction between age and weight

* Overall I am not super convinced by the bodyweight and age interaction term. It seems like there is some skews to the data that could be putting less heavy lifters in the older categories, while there is high overrepresentation of young lifters there (Raw, Wraps).

* On the other hand, the large effect size of Age and Bodyweight separately and in opposite directions is consistent among all categories. It is strange that the effect of age is __much smaller__ in raw and single-ply categories.

* Something smells fishy here though! (and no it's not the knee sleeves I haven't washed in 3 months)
  + We saw that both Age and Weight have some effect on the weight lifted by people, but do we just see a large proportion of monster heavyweight lifters in the older categories?
  + Let me clarify here - big guys lift big weights (generally) -> case and point

```{r}
ggplot(men2,
       aes(x=BodyweightKg,y=TotalKg,color=Equipment))+
  geom_point(cex=.3)+
  facet_wrap(~Equipment) +
  geom_smooth(method=lm)

```

 + There's fewer big guys in the higher age ranges

```{r}
ggplot(men2,
       aes(x=Group,y=BodyweightKg,color=TotalKg))+
  geom_violin(draw_quantiles=c(0.5),aes(fill=Group),trim=FALSE)+
  scale_color_gradient2(guide="colourbar",low="yellow",mid="gold",high="red") +
  facet_wrap(~Equipment) +
  theme(axis.text.x=element_text(angle=90))
```

* __BUT__ I think it becomes obvious that these relationships behave very differently if we talk about means and maximums. These two metrics paint two separate pictures and I think bodyweight may be part of the explanation (at least in this dataset)
  + What you see below is the median (less affected by skew than the mean) total weight lifted in each weight category, as well as the maximum weight lifted

```{r}
ggplot(men2,
       aes(x=Group,y=TotalKg,fill=Group))+
  geom_violin(draw_quantiles=c(0.5),aes(fill=Group),trim=FALSE) +
  facet_wrap(~Equipment) +
  theme(axis.text.x=element_text(angle=90))

menmed<-men2 %>% 
  filter(!is.na(Group),!is.na(BodyweightKg),!is.na(TotalKg)) %>% 
  group_by(Group,Equipment) %>% 
  summarize(med_lifts=median(TotalKg))

menmax<-men2 %>% 
  filter(!is.na(Group),!is.na(BodyweightKg),!is.na(TotalKg)) %>% 
  group_by(Group,Equipment) %>% 
  summarize(max_lifts=max(TotalKg))

ggplot(menmed,
       aes(x=Group,y=med_lifts,color=Equipment))+
  geom_point()+
  facet_wrap(~Equipment)+
  theme(axis.text.x=element_text(angle=90))

ggplot(menmax,
       aes(x=Group,y=max_lifts,color=Equipment))+
  geom_point()+
  facet_wrap(~Equipment)+
  theme(axis.text.x=element_text(angle=90))


```

* What you see is that the maximum weight lifted in each category declines much more rapidly than the average weight. This does differ between Equipment type with Raw being the smoothest decline and Multi-ply seeming to be the strongest
  + as example let's take the difference between average 23-25 category and 50-52

```{r}
med<-menmed %>% 
  filter(Group=="25-29" || Group=="50-54")

max<-menmax %>% 
  filter(Group=="25-29" || Group=="50-54")

meddif<-c()
for(i in 1:(dim(med)[[1]]/2)){
  meddif[i]<-med[i,"med_lifts"]-med[i+4,"med_lifts"]
}

maxdif<-c()
for(i in 1:(dim(max)[[1]]/2)){
  maxdif[i]<-max[i,"max_lifts"]-max[i+4,"max_lifts"]
}
equip<-c("Multi-ply","Raw","Single-ply","Wraps")
names(meddif)<-equip
names(maxdif)<-equip
print(meddif)
print(maxdif)
```

* What you see here are the differences between median and then maximum weight lifted at those two age categories.
  + when we look at median, you see <90kg difference in all categories, and it is as small as 55 kg difference in mean total weight lifted in the raw division
  + when we look at maximums - __large__ differences appear!
  + Raw is still with the smallest difference of 177.5kg, while Multi-ply lifters lift 317.52 kg more as a maximum of the 25-29kg category than the maximum in the 50-55. __WHY__?
  + Let's resubset our data and see who is lifting those weights and how much do they weigh compared to their max counterparts in the older categories
  
```{r}
menmax<-men2 %>% 
  filter(!is.na(Group),!is.na(BodyweightKg),!is.na(TotalKg)) %>% 
  group_by(Group,Equipment,BodyweightKg) %>% 
  summarize(max_lifts=max(TotalKg))

equip<-c("Multi-ply","Raw","Single-ply","Wraps")

max<-c()
for(i in unique(menmax$Group)){
  for(j in equip){
  sub<-menmax %>% 
    filter(Group==i && Equipment==j)
  ord<-order(sub$max_lifts,decreasing=TRUE)
  sub2<-sub[ord,]
  max<-rbind(max,sub2[1,])
}
}

max2<-max %>% 
  filter(!is.na(Group)) %>% 
  mutate(size=BodyweightKg/200)

ggplot(max2,
       aes(x=Group,y=max_lifts,color=BodyweightKg))+
  geom_point(aes(cex=size))+
  facet_wrap(~Equipment)+
  theme(axis.text.x=element_text(angle=90))+
  scale_color_gradient2(guide="colourbar",low="yellow",mid="yellow",high="red")

```

* If that doesn't show it, what does. The size and redness of the dot is the weight of the lifter who made a maximum lift. As you get to the older categories, what you see is a consistent decline in both maximum lift and in weight of the lifter.

* Let's show this a little more explicitly with a relationship between weight lifted and weight of lifter

```{r}
ggplot(max2,
       aes(x=BodyweightKg,y=max_lifts,color=BodyweightKg))+
  geom_point(aes(cex=size))+
  facet_wrap(~Equipment)+
  scale_color_gradient2(guide="colourbar",low="yellow",mid="gold",high="red")
```


## Younglings

* Let's verify why I threw out the data of people under 22.
  + They create a hump in the distribution of Total weight lifted because they are still getting stronger. If we plot these side by side, you can see that lifters get stronger till about 23-25 and then plateau there.

```{r}
men3<-men %>% 
  filter(Age<26)

ggplot(men3,
       aes(x=Group,y=TotalKg,fill=Group))+
  geom_violin(draw_quantiles=c(0.5),aes(fill=Group),trim=FALSE) +
  facet_wrap(~Equipment) +
  theme(axis.text.x=element_text(angle=90))

ym<-lm(TotalKg~Age*BodyweightKg+Equipment,data=men3)
summary(ym)
```
* The linear model here reveals a strong positive relationship of both Age and Weight, but a small and barely significant relationship of the interaction term. This means that gaining weight at age 15 gives you slightly more advantage in your total lifts than gaining weight at 23, but slightly!

#Federation

* Let's take a look at the meets.csv file which gives us some more data on federations in which these occurred.

```{r}

men<-open %>%
  filter(BestBenchKg>0 & BestDeadliftKg>0 & BestSquatKg>0) %>% 
  filter(!is.na(Age)) %>% 
  filter(Sex=="M") %>% 
  filter(Federation==c("USAPL","USPA","IPF","IPL")) %>% 
  select(Equipment,Age,BodyweightKg,BestSquatKg,BestBenchKg,BestDeadliftKg,TotalKg,Wilks,Group,Federation)
 

ggplot(men,
       aes(x=Federation,y=TotalKg,fill=Federation))+
  geom_violin(draw_quantiles = 0.5,trim=FALSE)

```